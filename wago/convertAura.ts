const sampleWago = {
  _id: 'hVLym_eLv',
  type: 'WEAKAURA' as WagoAuraType,
  name: 'Mists of Tirna Scithe maze guessing game V2',
  slug: 'hVLym_eLv',
  url: 'https://wago.io/hVLym_eLv',
  visibility: {
    private: false,
    hidden: false,
    encrypted: false,
    restricted: false,
    deleted: false,
    public: true,
  },
  date: {
    created: '2020-11-03T14:52:15.307Z',
    modified: '2021-03-12T15:11:46.814Z',
  },
  expires: null,
  patch: 'Shadowlands 9.0.5',
  description: {
    text:
      '[b][size=30][color=#FF0000]Requires one set of the following Textures[/color]:[/size][/b]\nColorful version of icons:\nhttps://drive.google.com/file/d/10--sJHR24xRJE4UbtUSiEc1Bl3iADgW8/view?usp=sharing\nor\nhttps://mega.nz/file/mSpXnIRL#D5k9FAgq2paeqRrsWcCvuITQ4fLkCNkFYs5dZtIZhgs\n\nWhite Version of icons:\nhttps://drive.google.com/file/d/1Fj8HN1mTGwKeGvSMFu26AK_U-cPqpn2w/view?usp=sharing\nor\nhttps://mega.nz/file/bTgH0aRB#PbwiBrJSBC3fDKvE8k0RlAdqgoC2VlcSJxqgqyIxzPE\n\n[size=20]Install > (./_retail_/Interface/AddOns/guess/***.tga) > /reload[/size]\n\nThe folder "guess" should be extracted to your addons folder and should look like (./_retail_/Interface/AddOns/guess). All case sensitive.\nIf you install this folder while in-game you need to a /reload or it will just look like grey/green boxes. \nLike an addon, it won\'t load textures until a /reload has happened to actually load the textures into the game.\n(Example of correct install: https://i.imgur.com/2hLioIl.png )\n\nIf you are seeing Borders around the icons then you need to turn off the special Weakaura in Masque. /masque > Weakauras \nThen disable the following here: circle_leaf_fill, circle_leaf_nofill, circle_lotus_fill, circle_lotus_nofill, nocircle_leaf_fill, nocircle_leaf_nofil, nocircle_noleaf_fill, nocircle_noleaf_nofill\n(Example of borders: https://i.imgur.com/k6LbqxG.png ) - Thanks to DESCADIA for solving this issue.\n\nThis weakaura communicates to party members.\nUse Group Scale to resize if needed. Thinking about just getting rid of the reset bar, any feedback welcome. \n\nv2.0.0 released - Added left click select and right click deselect, Auto reset on wall interaction (only when answer found), removed auto reset on just solution found. (Fresh install reccommended)\n\nNow works for both dungeon queued instances and non queued groups.\nNow also works completely solo.\nI believe I have fixed the issue of queued to M0 dungeons not sending anything when clicked. (1.2.7+)\nAdded order of clicked icons in bottom corner with a custom option to toggle showing or not showing. (1.3.7+)\nAdded option to change the selected and solution border colours. (1.3.9+)\nAdded announcement feature in chat which can be configured in Custom Options. (1.4.2+)\nAdded Lotus or Flower option in Custom Options. (1.4.3+)\nAdded announcement style selector in Custom Options. (1.4.5+)\nAdded option for when to announce based on role. (1.4.7+)\nAdded Experimental Setting that allows for solutions with only 3 symbol\'s selected. May have conflicts if someone is running an older version in group. (1.5.0+)\nDisable Communication of WA (i.e. Don\'t send or receive from party members) (1.5.3+)\nUse English instead of Regional Language (1.5.3+)\nAdded version control (1.6.0+)\nAdded output of who reset and if they are running pre 1.6.0 version. (1.6.0+)\nAdded option to disable communication with older versions. This fixes the glitches at the cost of less people to initially communicate with until they update (1.6.4+)\nAdded left click select and right click deselect, Auto reset on wall interaction (only when answer found), removed auto reset on just solution found. (v2.0.0)\n\nDebug mode allows you to see the wa in the whole instance and show what was received by the WA.\n\nRussian/German/Chinese(simplified)/Portuguese-BR/Spanish/French/Korean/Italian/Chinese(Traditional)/Spanish(Mexican) client version localizations implemented. (also added Dutch, non-client based)\nFOR NON-ENGLISH CLIENTS, Only ptPT client\'s missing:\nIf you want to go further with full translation then I\'d need translations for:\n"Solution"\n"NO CIRCLE"\n"CIRCLE"\n"LEAF"\n"LOTUS"\n"EMPTY" or "NOT FILLED" (whichever works better for your language)\n"FILLED"\n"No solution found"\n"Sigil sent by"\n"Total provided"\n"Duplicated input"\n"No submissions yet"/"No entries yet"\n"Reset"\n"Last Solution"/"Previous Solution"\n"[url=www.wowhead.com/npc=170217]MistCaller[/url]" - Boss NPC name for some regions\n\nThanks to:\nRybus - Russian Translation\nDESCADIA - German Translation\nSaisaki - Chinese(Simplified) Translation\nRadunz - Portuguese-BR Translation\nSiok0 - Spanish Translation\nXylo - French Translation\n - Korean Translation\nliyal - Italian Translation\nGioVannI#3425 - Chinese(Traditional) Translation\np0lzl#1726 - Spanish(Mexican)\nXzeajan - Dutch\n\nFork of (https://wago.io/0TW2TiUUq) by enragednuke',
    format: 'bbcode' as 'bbcode' | 'markdown',
  },
  categories: ['sldungeon', 'sldungeon3'],
  regionType: 'dynamicgroup',
  attachedMedia: [],
  game: 'sl',
  viewCount: 28468,
  viewsThisWeek: 4138,
  commentCount: 167,
  downloadCount: 0,
  embedCount: 0,
  favoriteCount: 754,
  installCount: 21254,
  UID: '5cd9e8f746de737c97aa6ca7',
  alerts: {},
  collectionCount: 14,
  collections: [
    {
      name: 'M+',
      _id: 'QuuWkUvmO',
      slug: 'QuuWkUvmO',
      modified: '2021-03-04T03:20:32.411Z',
      user: {
        name: 'toanqc',
        class: 'user-default',
        avatar: {
          webp:
            'https://media.wago.io/avatars/5bc21f49481a2a1c802b87d8/adorable-1539448650045.webp',
          png:
            'https://media.wago.io/avatars/5bc21f49481a2a1c802b87d8/adorable-1539448650045.png',
        },
        profile: '/p/toanqc',
      },
    },
  ],
  myCollections: ['QuuWkUvmO'],
  user: {
    name: 'Saxayone#2791' as string | undefined,
    searchable: true,
    roleClass: 'user-default',
    avatar: {
      webp:
        'https://media.wago.io/avatars/5cd9e8f746de737c97aa6ca7/b-1557785439228.webp',
      png:
        'https://media.wago.io/avatars/5cd9e8f746de737c97aa6ca7/b-1557785439228.png',
    },
    enableLinks: true,
  },
  screens: [
    {
      _id: '5fdac7689f01f8188515cbf4',
      src:
        'https://media.wago.io/screenshots/hVLym_eLv/5fdac7689f01f8188515cbf4.gif',
      thumb:
        'https://media.wago.io/screenshots/hVLym_eLv/5fdac7689f01f8188515cbf4.gif',
    },
    null,
  ],
  translations: false,
  codeReviewComments: {},
  videos: [
    {
      _id: '57c07a709d566c471f488ec7',
      url: 'https://www.youtube.com/embed/RBL2W6jNgxo?autoplay=1',
      thumb: 'https://img.youtube.com/vi/RBL2W6jNgxo/0.jpg' as
        | string
        | undefined,
      embed:
        '<iframe src="https://www.youtube.com/embed/RBL2W6jNgxo&autoplay=1" frameborder="0" scrolling="no"></iframe>',
    },
  ],
  comments: [
    {
      cid: '604ce588018d42430ee6e975',
      date: '2021-03-13T16:17:12.002Z',
      text:
        '[taggeduser]@Saxayone#2791[/taggeduser] fresh install, working. thanks for the advice',
      format: 'bbcode',
      canMod: false,
      author: {
        name: 'Ypi',
        avatar: {
          png:
            'https://media.wago.io/avatars/58b8231d4633f0850e6b2857/discord-1536218974219.png',
          webp:
            'https://media.wago.io/avatars/58b8231d4633f0850e6b2857/discord-1536218974219.webp',
        },
        class: 'user-default',
        profile: '/p/Ypi',
        enableLinks: true,
      },
    },
  ],
  versions: {
    total: 68,
    versions: [
      {
        version: 66,
        versionString: '2.0.1-66',
        size: 122292,
        date: '2021-03-12T15:11:46.805Z',
        changelog: {
          text:
            'V2.0.0 - Revamped a number of things. Left click select, Right Click deselect added, Auto reset on wall interaction (while answer found)',
          format: 'bbcode',
        },
      },
    ],
  },
  codeURL: '/lookup/wago/code?id=hVLym_eLv&version=2.0.1-66',
  s3screens: [
    'https://elasticbeanstalk-us-east-2-577827958072.s3.us-east-2.amazonaws.com/screens/abcdefgh.webm',
  ] as string[] | undefined,
  code: '' as string | null | undefined,
  newCategories: [] as Aura.Category[] | undefined,
}

export type WagoAura = typeof sampleWago

type WagoAuraType =
  | 'WEAKAURA'
  | 'MDT'
  | 'ELVUI'
  | 'PLATER'
  | 'VUHDO'
  | 'CLASSIC-WEAKAURA'
  | 'TOTALRP3'

class UnsupportedAura extends Error {
  constructor(message: string) {
    super('Unsupported aura: ' + message)
    this.name = 'UnsupportedAura'
  }
}

const convertType = (type: WagoAuraType): Aura.Type => {
  switch (type) {
    case 'WEAKAURA':
      return 'weakaura'
    case 'PLATER':
      return 'plater'
    case 'ELVUI':
      return 'elvui'
    case 'MDT':
      return 'mdt'
    case 'CLASSIC-WEAKAURA':
      return 'classic-weakaura'
    case 'VUHDO':
      return 'vuhdo'
    case 'TOTALRP3':
      return 'totalrp3'
    default:
      throw new UnsupportedAura(`type: ${type}`)
  }
}

const supportedExts = ['.webm', '.webp', '.jpg', '.png']
const mergeScreensVideos = (
  videos: WagoAura['videos'],
  screens: string[] | undefined,
) => {
  if (screens === undefined) {
    throw new UnsupportedAura('missing screens')
  }

  const res: Aura.Media[] = []
  videos.forEach((video) => {
    const item: Aura.Media = { type: 'video', src: video.url }
    if (video.thumb) item.thumb = video.thumb
    res.push(item)
  })
  screens.forEach((screen) => {
    if (!supportedExts.some((ext) => screen.toLowerCase().endsWith(ext))) {
      throw new UnsupportedAura(`invalid screen extension: ${screen}`)
    }

    res.push({ type: 'screen', src: screen })
  })
  return res
}

const convertCode = (code: string | null | undefined) => {
  if (code === undefined) {
    throw new UnsupportedAura('missing code')
  }

  if (code === null) {
    throw new UnsupportedAura('code is null')
  }

  return code
}

const convertCategories = (newCategories: Aura.Category[] | undefined) => {
  if (newCategories === undefined) {
    throw new UnsupportedAura('missing newCategorise')
  }

  return newCategories
}

export const convertErrors: string[] = []
export const convertAura = (wago: WagoAura): Aura.Aura | null => {
  try {
    return {
      id: wago.slug,
      type: convertType(wago.type),
      dateCreated: wago.date.created,
      dateModified: wago.date.modified,
      code: convertCode(wago.code),
      name: wago.name,
      categories: convertCategories(wago.newCategories),
      description: wago.description,
      views: wago.viewCount,
      gallery: mergeScreensVideos(wago.videos, wago.s3screens),
      wago: {
        url: wago.url,
        username: wago.user.name || '',
      },
    }
  } catch (error) {
    if (error.name === 'UnsupportedAura') {
      convertErrors.push(error.message)
      return null
    }

    throw error
  }
}
